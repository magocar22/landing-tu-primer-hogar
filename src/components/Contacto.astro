---
// src/components/Contacto.astro
import { WP_URL } from '../lib/wordpress'; // Importamos la URL centralizada

const { simple = false, tipo = 'Cliente' } = Astro.props; // 'Cliente' o 'Inversor'

// Textos visuales
const textoBoton = tipo === 'Inversor' ? "Solicitar Dossier" : "Solicitar información";
const placeholderMensaje = tipo === 'Inversor'
    ? "Estoy interesado en oportunidades de inversión..."
    : "Me gustaría saber más sobre cómo acceder a una vivienda...";

// ID del Formulario en WordPress (CF7)
// ¡IMPORTANTE! Cambia este número por el ID real que te dé WordPress al crear el formulario
const FORM_ID = "8079e0a";

// Preparamos la URL base limpia para el script
const API_URL = WP_URL.replace(/\/$/, '');
---

<div class={simple ? "w-full" : "py-16 md:py-24 bg-blue-50"} id="contacto">
  <div class={simple ? "" : "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"}>
    
    <div class={simple ? "" : "grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20 items-start"}>
      
      <!-- Texto Ayuda -->
      {!simple && tipo !== 'Inversor' && (
        <div class="space-y-8">
            <div>
                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">¿Tienes dudas?</h2>
                <p class="text-gray-600 text-lg leading-relaxed">
                    Nuestro equipo te explicará paso a paso cómo funciona el modelo sin entrada.
                </p>
            </div>
        </div>
      )}

      <!-- FORMULARIO -->
      <div class={simple ? "" : "bg-white rounded-3xl shadow-xl p-8 md:p-10 border border-gray-100"}>
        
        <form id="wp-contact-form" class="space-y-4">
          
          <!-- CAMPO OCULTO (Tipo de perfil) -->
          <input type="hidden" name="profile-type" value={tipo}>
      
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre completo</label>
            <input type="text" name="your-name" required placeholder="Tu nombre" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none" />
          </div>
      
          <div class={simple ? "grid grid-cols-1 gap-4" : "grid grid-cols-1 md:grid-cols-2 gap-6"}>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" name="your-email" required placeholder="tu@email.com" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
              <input type="tel" name="your-phone" required placeholder="600 00 00 00" class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none" />
            </div>
          </div>
      
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje</label>
            <textarea name="your-message" rows={simple ? "3" : "4"} required placeholder={placeholderMensaje} class="w-full px-4 py-3 rounded-lg bg-gray-50 border border-gray-200 focus:border-blue-500 outline-none resize-none"></textarea>
          </div>
      
          <div class="flex items-start">
            <input type="checkbox" name="acceptance" value="1" required class="mt-1 w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
            <span class="ml-2 text-xs text-gray-500">Acepto la <a href="/politica-privacidad" target="_blank" class="text-blue-600 hover:underline">Política de Privacidad</a>.</span>
          </div>
      
          <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white font-bold py-3.5 px-6 rounded-xl hover:bg-blue-700 transition-colors shadow-md">
            {textoBoton}
          </button>
      
          <div id="result" class="hidden text-center p-3 text-sm rounded-lg mt-2 font-medium"></div>
      
        </form>
      </div>

    </div>
  </div>
</div>

<script is:inline define:vars={{ API_URL, FORM_ID }}>
  const form = document.getElementById('wp-contact-form');
  const result = document.getElementById('result');
  const btn = document.getElementById('btn-submit');

  if(form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        // Efecto visual "Enviando"
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = `<span class="animate-pulse">Enviando...</span>`;
        btn.disabled = true;
        result.classList.add('hidden');

        try {
            // URL dinámica basada en la configuración global
            const endpoint = `${API_URL}/wp-json/contact-form-7/v1/contact-forms/${FORM_ID}/feedback`;
            
            const response = await fetch(endpoint, {
                method: 'POST',
                body: formData 
            });

            // Parsear respuesta
            const data = await response.json();

            // CF7 devuelve status: 'mail_sent' si todo fue bien
            if (data.status === 'mail_sent') {
                result.innerHTML = "✅ Mensaje recibido correctamente. Contactaremos contigo pronto.";
                result.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                result.classList.add('bg-green-100', 'text-green-700');
                form.reset();
            } else {
                // Manejo de errores específicos (spam, campos vacíos, error servidor)
                throw new Error(data.message || "Error al procesar el envío");
            }

        } catch (error) {
            console.error("Error envío:", error);
            result.innerHTML = "❌ Hubo un error al enviar. Por favor, revisa los campos o inténtalo más tarde.";
            result.classList.remove('hidden', 'bg-green-100', 'text-green-700');
            result.classList.add('bg-red-100', 'text-red-700');
        } finally {
            btn.innerHTML = textoOriginal;
            btn.disabled = false;
        }
      });
  }
</script>